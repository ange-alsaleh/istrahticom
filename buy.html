<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Ø´Ø¨ÙƒØ© Ø§Ù„Ø¶ÙŠØ§Ø¡-Ù†Øª</title>
  <style>
    :root{
      --bg:#15213b; --card:#1b2746; --neon:#00f7ff; --ink:#0f4862; --light:#ffffff;
    }
    body{
      font-family:'Tajawal',system-ui,Segoe UI,Arial; background:var(--bg); color:#fff; margin:0;
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .wrap{
      width:100%; max-width:520px; background:rgba(27,39,70,.95);
      border-radius:16px; box-shadow:0 0 16px rgba(0,247,255,.35); overflow:hidden;
      border:1px solid rgba(0,247,255,.35);
    }
    header{
      display:flex; align-items:center; gap:12px; padding:14px 16px;
      background:linear-gradient(90deg, #101a33, #0a2b4b);
      border-bottom:1px solid rgba(0,247,255,.25);
    }
    header img{ width:40px; height:40px; border-radius:50%; object-fit:cover; box-shadow:0 0 8px var(--neon); }
    header .titles{ display:flex; flex-direction:column; line-height:1.2 }
    .title{ font-weight:700; color:var(--light); text-shadow:0 0 6px var(--neon) }
    .sub{ font-size:12px; opacity:.9 }
    .chip{ margin-right:auto; font-size:12px; background:rgba(0,247,255,.12); border:1px solid rgba(0,247,255,.35);
      color:var(--light); padding:4px 8px; border-radius:999px; }
    #messages{
      padding:16px; height:60vh; min-height:380px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;
      background:rgba(0,0,0,.15);
    }
    .bubble{
      max-width:78%; padding:10px 14px; border-radius:16px; box-shadow:0 4px 10px rgba(0,0,0,.18);
      word-wrap:break-word; white-space:pre-wrap; line-height:1.4; font-size:15px;
      position:relative;
    }
    .bubble.user{
      align-self:flex-end; background:var(--ink); border:1px solid var(--neon);
      border-top-left-radius:6px;
    }
    .bubble.admin{
      align-self:flex-start; background:rgba(0,247,255,.15); color:#dff9ff; border:1px solid rgba(0,247,255,.5);
      border-top-right-radius:6px;
    }
    .time{ display:block; opacity:.7; font-size:11px; margin-top:6px }
    .toolbar{
      padding:10px; display:flex; gap:8px; border-top:1px solid rgba(0,247,255,.25); background:#0e1a33;
    }
    .toolbar button, .toolbar .clean{
      background:rgba(0,247,255,.12); color:#fff; border:1px solid rgba(0,247,255,.35);
      border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700
    }
    .toolbar button:hover{ background:rgba(0,247,255,.22) }
    #composer{
      display:flex; border-top:1px solid rgba(0,247,255,.25); background:#0b1731;
      gap:8px; padding:10px;
    }
    #messageInput{
      flex:1; border:none; border-radius:12px; padding:12px 14px; font-size:15px; color:#fff;
      background:rgba(0,0,0,.3); outline:none;
    }
    #sendBtn{
      min-width:86px; border:none; border-radius:12px; background:var(--neon); color:#07111f;
      font-weight:800; cursor:pointer;
    }
    #sendBtn:active{ transform:translateY(1px) }
    .note{ color:#bdefff; font-size:12px; text-align:center; padding:8px 12px; opacity:.85 }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img id="brandLogo" src="img/logo.png" alt="logo">
      <div class="titles">
        <div class="title">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ â€” Ø´Ø¨ÙƒØ© Ø§Ù„Ø¶ÙŠØ§Ø¡-Ù†Øª</div>
        <div class="sub">Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ! Ø£ÙƒØªØ¨ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ.</div>
      </div>
      <span class="chip" id="chipStatus">Ù…ØªØµÙ„</span>
    </header>

    <div id="messages"></div>

    <div class="toolbar">
      <button id="allowPush">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ğŸ””</button>
      <button id="clearChat">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ğŸ—‘ï¸</button>
      <span class="clean" id="chatIdBadge" title="Ù…Ø¹Ø±Ù‘Ù Ù…Ø­Ø§Ø¯Ø«ØªÙƒ"></span>
    </div>

    <div id="composer">
      <input id="messageInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§â€¦" autocomplete="off" />
      <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <div class="note">ğŸš€ Ø³ØªØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø±Ø¯Ù‘ Ø§Ù„Ø¯Ø¹Ù… Ø­ØªÙ‰ ÙˆØ£Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙØ­Ø©.</div>
  </div>

  <!-- Firebase v12 (ESM) -->
  <script type="module">
    /***** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¹Ù†Ø§ÙˆÙŠÙ† Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ *****/
    const VAPID_KEY = "BCtAdlmYCinSR7QmgiZzkz2hNg8_pfQJYWyLV1R3RmnnELxUUQST6rPwjRovxl40-DSundiW-n30C-Dt3_ICD88"; // â† ÙƒÙ…Ø§ Ø£Ø¹Ø·ÙŠØªÙ†ÙŠ
    const LOGO_PATH = "img/logo.png";        // ØºÙŠØ±Ù‡Ø§ Ù„Ùˆ ØªØ¨ØºÙ‰
    const SOUND_PATH = "notification.mp3";   // ØºÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù…Ù„Ù ØµÙˆØª Ø¢Ø®Ø±

    /***** Imports *****/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-messaging.js";

    /***** Firebase Config *****/
    const firebaseConfig = {
      apiKey: "AIzaSyAwjmWIOyvGKUAXqDKpzpouZ-MlyuhYjMc",
      authDomain: "support-chat-31aa6.firebaseapp.com",
      databaseURL: "https://support-chat-31aa6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "support-chat-31aa6",
      storageBucket: "support-chat-31aa6.appspot.com",
      messagingSenderId: "1079004120541",
      appId: "1:1079004120541:web:4a11ee42427c6e9be1e234",
      measurementId: "G-8NNELSESB8"
    };

    /***** ØªÙ‡ÙŠØ¦Ø© *****/
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // chatId Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù„ÙƒÙ„ Ø²Ø¨ÙˆÙ†
    let chatId = localStorage.getItem("chatId");
    if (!chatId) {
      chatId = Math.random().toString(36).slice(2, 11);
      localStorage.setItem("chatId", chatId);
    }
    document.getElementById('chatIdBadge').textContent = `ID: ${chatId}`;

    // Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
    const chatRef = ref(db, `supportMessages/${chatId}`);

    // Ø¹Ù†Ø§ØµØ± DOM
    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearChat');
    const allowPushBtn = document.getElementById('allowPush');

    // ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    let ping;
    try { ping = new Audio(SOUND_PATH); } catch(e){}

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±ÙŠØ©
    function showMessage({sender, message, timestamp}) {
      const bubble = document.createElement('div');
      bubble.className = `bubble ${sender === 'admin' ? 'admin' : 'user'}`;
      bubble.innerHTML = `${escapeHtml(message)}<span class="time">${formatTime(timestamp)}</span>`;
      messagesDiv.appendChild(bubble);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      if (sender === 'admin' && ping) { ping.play().catch(()=>{}); }
    }
    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }
    function formatTime(t){
      const d = t ? new Date(t) : new Date();
      let h = d.getHours(), m = String(d.getMinutes()).padStart(2,'0');
      const ampm = h>=12 ? 'Ù…' : 'Øµ'; h = h%12 || 12;
      return `${h}:${m} ${ampm}`;
    }

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙ‚Ø·)
    onChildAdded(chatRef, snap => {
      const data = snap.val();
      if (!data) return;
      showMessage(data);
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      sendBtn.disabled = true;
      try{
        await push(chatRef, {
          sender: 'user',
          message: text,
          timestamp: Date.now()
        });
        input.value = "";
      } catch(err){
        alert('ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
        console.error(err);
      } finally{
        sendBtn.disabled = false;
        input.focus();
      }
    }
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', e=>{
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    // Ø­Ø°Ù Ù…Ø­Ø§Ø¯Ø«ØªÙŠ ÙÙ‚Ø·
    clearBtn.addEventListener('click', async ()=>{
      if (!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ù…Ø­Ø§Ø¯Ø«ØªÙƒ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
      try{
        await remove(chatRef);
        messagesDiv.innerHTML = "";
      } catch(e){
        alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¢Ù†'); console.error(e);
      }
    });

    // ØªØ³Ø¬ÙŠÙ„ Service Worker + ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª + Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†
    async function enablePush() {
      try{
        // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…Ù„Ù SW ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø£ØµÙ„ ÙˆØ§Ù„Ù…Ø³Ø§Ø± ØµØ­ÙŠØ­
        await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log('SW registered');

        if (!(await isSupported())) {
          alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙˆÙŠØ¨ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².');
          return;
        }

        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          alert('Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.');
          return;
        }

        const messaging = getMessaging(app);
        const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: await navigator.serviceWorker.ready });
        if (token) {
          console.log('FCM token', token);
          // Ø®Ø²Ù‘Ù† Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          const tokenRef = ref(db, `userTokens/${chatId}`);
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø³ÙŠØ·Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ø¶Ø§ÙÙŠ â€” Ù„ÙƒÙ† Ø¹Ù†Ø¯Ù†Ø§ DB Ø¬Ø§Ù‡Ø²ØŒ Ù†Ù‚Ø¯Ø± Ù†Ø³ØªØ®Ø¯Ù… push/ set Ø¹Ø¨Ø± REST Ø£Ùˆ Ù†Ø¶ÙŠÙ import set:
        } else {
          alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† FCM.');
        }
      } catch(err){
        console.error('Push error', err);
        alert('ØªØ¹Ø°Ù‘Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.');
      }
    }

    // Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù„Ù… Ù†Ø³ØªÙˆØ±Ø¯ set ØµØ±Ø§Ø­Ø© ÙÙˆÙ‚ØŒ Ù†Ø¶ÙŠÙÙ‡ Ù‡Ù†Ø§ ÙˆÙ†Ø³ØªØ®Ø¯Ù…Ù‡
    import("https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js").then(({set})=>{
      allowPushBtn.addEventListener('click', async ()=>{
        try{
          await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') { alert('Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø±ÙÙˆØ¶.'); return; }
          const messaging = getMessaging(app);
          const reg = await navigator.serviceWorker.ready;
          const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
          if (!token){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†.'); return; }
          await set(ref(db, `userTokens/${chatId}`), token);
          alert('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }catch(e){
          console.error(e); alert('ØªØ¹Ø°Ù‘Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.');
        }
      });
    });

    // Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§: Ø£Ø¸Ù‡Ø± Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±
    document.getElementById('brandLogo').src = LOGO_PATH;
  </script>
</body>
</html>
